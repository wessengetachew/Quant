<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farey Alpha Pro - Live Market Engine</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { font-family: 'Inter', -apple-system, sans-serif; background: #0b0e14; color: #d1d4dc; margin: 0; padding: 20px; }
        .grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; max-width: 1400px; margin: auto; }
        .panel { background: #161a25; padding: 20px; border-radius: 12px; border: 1px solid #2a2e39; }
        #chart-container { height: 500px; width: 100%; border-radius: 12px; overflow: hidden; border: 1px solid #2a2e39; }
        .input-group { margin-bottom: 15px; }
        input, select { width: 100%; padding: 10px; background: #2a2e39; border: 1px solid #363c4e; color: white; border-radius: 6px; box-sizing: border-box; }
        .metric { font-size: 24px; font-weight: bold; color: #2962ff; margin: 10px 0; }
        .label { font-size: 12px; color: #787b86; text-transform: uppercase; letter-spacing: 1px; }
        .timeframes { display: flex; gap: 5px; margin-bottom: 10px; }
        .tf-btn { flex: 1; padding: 8px; font-size: 12px; background: #2a2e39; border: none; color: white; cursor: pointer; border-radius: 4px; }
        .tf-btn.active { background: #2962ff; }
        .unity-active { border: 2px solid #f2c94c; background: rgba(242, 201, 76, 0.1); padding: 10px; border-radius: 8px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="grid">
    <div class="panel">
        <h2 style="margin-top:0; color:white;">Farey Sector Control</h2>
        
        <div class="input-group">
            <span class="label">Symbol</span>
            <input type="text" id="symbol-input" value="BTCUSDT" placeholder="e.g. AAPL, BTCUSDT, TSLA">
            <button onclick="updateSymbol()" style="margin-top:5px; width:100%; padding:8px; cursor:pointer; background:#2962ff; color:white; border:none; border-radius:4px;">Load Asset</button>
        </div>

        <div class="timeframes">
            <button class="tf-btn" onclick="setTimeframe('1h')">1H</button>
            <button class="tf-btn active" onclick="setTimeframe('1d')">1D</button>
            <button class="tf-btn" onclick="setTimeframe('1w')">1W</button>
            <button class="tf-btn" onclick="setTimeframe('1m')">1M</button>
        </div>

        <hr style="border:0; border-top:1px solid #2a2e39; margin: 20px 0;">

        <div class="label">Current Sector (n)</div>
        <div class="metric" id="display-n">--</div>

        <div class="label">Farey Density $C(n, N)$</div>
        <div class="metric" id="display-density" style="color:#00c853;">--</div>

        <div class="input-group">
            <span class="label">N-Range Resolution</span>
            <input type="number" id="input-n" value="2000" onchange="calculateFarey()">
        </div>

        <div id="unity-alert" class="unity-active">
            <strong style="color:#f2c94c;">⚡ UNITY BOUND REACHED</strong><br>
            <span style="font-size: 11px;">Range N optimized at $\frac{\sqrt{3}}{\pi}$ for this price point.</span>
        </div>
    </div>

    <div id="chart-container"></div>
</div>

<script>
    let chart, candleSeries, lineSeries;
    let currentPrice = 0;
    const PI_SQ = Math.pow(Math.PI, 2);

    // Initialize Chart
    function initChart() {
        const container = document.getElementById('chart-container');
        chart = LightweightCharts.createChart(container, {
            layout: { backgroundColor: '#161a25', textColor: '#d1d4dc' },
            grid: { vertLines: { color: '#2a2e39' }, horzLines: { color: '#2a2e39' } },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            priceScale: { borderColor: '#2a2e39' },
            timeScale: { borderColor: '#2a2e39', timeVisible: true }
        });

        candleSeries = chart.addCandlestickSeries({
            upColor: '#26a69a', downColor: '#ef5350', borderVisible: false,
            wickUpColor: '#26a69a', wickDownColor: '#ef5350'
        });

        // Add a line for the "Unity Bound"
        lineSeries = chart.addLineSeries({ color: '#f2c94c', lineWidth: 2, lineStyle: 2 });
    }

    // Fetch Real Market Data (using Binance public API for demo)
    async function fetchData(symbol = 'BTCUSDT', interval = '1d') {
        const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol.toUpperCase()}&interval=${interval}&limit=100`);
        const data = await response.json();
        
        const formattedData = data.map(d => ({
            time: d[0] / 1000,
            open: parseFloat(d[1]),
            high: parseFloat(d[2]),
            low: parseFloat(d[3]),
            close: parseFloat(d[4])
        }));

        candleSeries.setData(formattedData);
        currentPrice = formattedData[formattedData.length - 1].close;
        calculateFarey();
    }

    function calculateFarey() {
        const N = parseFloat(document.getElementById('input-n').value);
        // Normalize: We treat the nearest power of 10 as the "ceiling" for the sector
        const magnitude = Math.pow(10, Math.floor(Math.log10(currentPrice)) + 1);
        const normPrice = currentPrice / magnitude;

        const n = Math.floor(1 / normPrice);
        const density = (3 * Math.pow(N, 2)) / (PI_SQ * n * (n + 1));

        document.getElementById('display-n').innerText = n;
        document.getElementById('display-density').innerText = Math.round(density).toLocaleString();

        // Unity Bound check: n ≈ N * (sqrt(3)/pi)
        const unityN = Math.floor(N * (Math.sqrt(3) / Math.PI));
        const alertBox = document.getElementById('unity-alert');
        
        if (Math.abs(n - unityN) < (N * 0.05)) { // 5% tolerance
            alertBox.style.display = 'block';
        } else {
            alertBox.style.display = 'none';
        }

        // Draw Unity Pivot on chart
        const unityPrice = (1 / unityN) * magnitude;
        lineSeries.setData([
            { time: candleSeries.data ? candleSeries.data[0].time : 0, value: unityPrice },
            { time: Date.now() / 1000, value: unityPrice }
        ]);
    }

    function updateSymbol() {
        const sym = document.getElementById('symbol-input').value;
        fetchData(sym);
    }

    function setTimeframe(tf) {
        document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        const map = {'1h':'1h', '1d':'1d', '1w':'1w', '1m':'1M'};
        fetchData(document.getElementById('symbol-input').value, map[tf]);
    }

    initChart();
    fetchData(); // Default load
</script>

</body>
</html>
